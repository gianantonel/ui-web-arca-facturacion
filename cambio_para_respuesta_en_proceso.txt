def page_confirmed():
    st.title("Confirmaci√≥n")
    st.write("Si todo est√° correcto, envi√° los datos al workflow de n8n.")
    st.divider()

    payload = st.session_state["last_payload"]
    if not payload:
        st.warning("No hay datos confirmados. Volviendo a edici√≥n.")
        st.session_state["step"] = "edit"
        st.rerun()

    tot = payload.get("totales", {}) or {}
    tipo_factura = tot.get("tipo_factura", None)
    con_iva = is_factura_con_iva(tipo_factura)

    st.markdown("#### Items (Resumen)")
    calc_items = tot.get("items_calculados", []) or []
    st.dataframe(
        [
            {
                "C√≥digo": it.get("codigo", ""),
                "Descripci√≥n": it.get("descripcion", ""),
                "Cantidad": it.get("cantidad", ""),
                "Unidad": it.get("unidad_medida", ""),
                "Modo Precio": ("Con IVA" if it.get("precio_modo") == "con_iva" else "Sin IVA") if con_iva else "-",
                "Precio Ingresado": it.get("precio_unitario", ""),
                "Descuento": it.get("descuento_bonificacion", ""),
                "Subtotal": (calc_items[i].get("subtotal_gross") if i < len(calc_items) else None),
            }
            for i, it in enumerate(payload.get("items", []))
        ],
        use_container_width=True,
        hide_index=True,
    )

    st.divider()
    st.markdown("#### Totales")
    st.write(f"Tipo de factura: **{tipo_factura or '-'}**")
    if con_iva:
        st.metric("TOTAL Neto", fmt_money(float(tot.get("total_neto", 0.0) or 0.0)))
        st.metric("IVA 21%", fmt_money(float(tot.get("total_iva_21", 0.0) or 0.0)))
        st.metric("TOTAL", fmt_money(float(tot.get("total", 0.0) or 0.0)))
    else:
        st.metric("TOTAL", fmt_money(float(tot.get("total", 0.0) or 0.0)))

    st.divider()
    # Secci√≥n colapsable para ver el JSON t√©cnico si se desea
    with st.expander("Ver datos t√©cnicos (JSON)"):
        st.json(payload)

    st.divider()
    col1, col2 = st.columns(2)
    with col1:
        if st.button("Volver a Editar"):
            st.session_state["step"] = "edit"
            st.rerun()

    with col2:
        # --- MODIFICACI√ìN PRINCIPAL AQU√ç ---
        if st.button("Enviar Datos"):
            # Iniciamos el bloque de estado visual
            with st.status("Iniciando proceso de facturaci√≥n...", expanded=True) as status:
                
                st.write("üíæ Guardando respaldo local...")
                safe_payload = make_json_safe(payload)
                path = save_json(safe_payload, folder="data")
                st.session_state["last_saved_path"] = str(path)

                st.write("üöÄ Enviando datos a n8n (AFIP/ARCA)...")
                st.write("_Esto puede demorar unos segundos..._")
                
                # Llamada bloqueante (espera a n8n)
                result = send_to_webhook(safe_payload)
                st.session_state["last_webhook_result"] = result

                # Actualizamos el estado visual seg√∫n el resultado
                if result["ok"]:
                    status.update(label="¬°Proceso Finalizado con √âxito! ‚úÖ", state="complete", expanded=False)
                else:
                    status.update(label="Hubo un error en el proceso ‚ùå", state="error", expanded=True)
            
            # NOTA: Quitamos st.rerun() intencionalmente para que el bloque de estado 
            # y el resultado de abajo se muestren inmediatamente sin recargar la p√°gina.

    # --- MOSTRAR RESULTADOS ---
    if st.session_state.get("last_saved_path"):
        st.caption(f"Respaldo JSON guardado en: `{st.session_state['last_saved_path']}`")

    if st.session_state.get("last_webhook_result"):
        res = st.session_state["last_webhook_result"]
        body = res.get("response", {})

        st.divider()
        if res["ok"]:
            st.success("‚úÖ Respuesta del Agente:")
            
            # Mensaje principal que venga de n8n
            msg = body.get("message", "Operaci√≥n exitosa") if isinstance(body, dict) else str(body)
            st.markdown(f"**{msg}**")

            # Si configuraste n8n para devolver "drive_link", mostramos un bot√≥n
            if isinstance(body, dict) and body.get("drive_link"):
                st.link_button("üìÇ Abrir Factura en Google Drive", body["drive_link"])
            
            # Mostrar resto de datos si es necesario
            with st.expander("Ver respuesta completa"):
                st.json(body)
        else:
            st.error("‚ùå Error devuelto por el workflow:")
            st.write(f"C√≥digo de estado: {res['status_code']}")
            st.json(body)